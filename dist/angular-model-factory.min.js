/**
 * modelFactory makes working with RESTful APIs in AngularJS easy
 * @version v1.0.5 - 2016-08-24
 * @link http://swimlane.github.io/angular-model-factory/
 * @author Austin McDaniel <amcdaniel2@gmail.com>, Juri Strumpflohner <juri.strumpflohner@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";!function(a,b){"function"==typeof define&&define.amd?define(["angular","uri-templates","deep-diff"],b):"undefined"!=typeof module&&module.exports?module.exports=b(require("angular"),require("uri-templates"),require("deep-diff")):a.ModelFactory=b(a.angular,a.UriTemplate,a.DeepDiff)}(this,function(a,b,c){var d=a.module("modelFactory",[]),e=a.isUndefined,f=a.forEach,g=a.extend,h=a.copy,i=["$$array","$save","$destroy","$pending","$rollback","$diff","$update","$commit","$copy"],j=["actions","instance","list","defaults","pk","stripTrailingSlashes","map"],k=function(b){return f(arguments,function(c){c!==b&&f(c,function(c,d){i.indexOf(d)===-1&&(b[d]?a.isArray(b[d])?b[d].concat(c.filter(function(a){var c=b[d].indexOf(a)!==-1;return c&&k(c,a),c})):a.isObject(b[d])?k(b[d],c):b[d]=c:a.isFunction(b[d])||(b[d]=c))})}),b},l=function(b,c){c=c||{},f(c,function(a,d){b.hasOwnProperty(d)||"$"===d.charAt(0)||delete c[d]});for(var d in b)b.hasOwnProperty(d)&&"$"!==d.charAt(0)&&(a.isObject(b[d])&&!a.isArray(b[d])?c[d]=l(b[d],c[d]):c[d]=b[d]);return c};return d.provider("$modelFactory",function(){var d=this;d.defaultOptions={prefix:"",pk:"id",stripTrailingSlashes:!0,defaults:{},map:{},actions:{base:{wrap:!0,beforeRequest:void 0,afterRequest:void 0,cache:!1},get:{method:"GET"},query:{method:"GET",isArray:!0},post:{method:"POST",invalidateCache:!0},update:{method:"PUT",invalidateCache:!0},delete:{method:"DELETE",invalidateCache:!0}},instance:{},list:{}},d.$get=["$rootScope","$http","$q","$log","$cacheFactory",function(m,n,o,p,q){function r(p,r){function s(a){a=a||[],a.forEach(function(b,c){null!==b&&void 0!==b&&(a[c]=x(b,a))});var b=a.push;return a.push=function(){for(var c=Array.prototype.slice.call(arguments),d=0;d<c.length;d++)c[d]=x(c[d],a);b.apply(a,c)},r.list&&g(a,r.list),a}function t(b){var d=this,e=[];b=b||{},f(r.defaults,function(a,c){void 0===b[c]&&("function"==typeof a?b[c]=h(a(b)):b[c]=h(a))}),f(r.map,function(a,c){y(a)===y(t)||y(a)===y(s)?b[c]=new a(b[c]):"function"==typeof a?b[c]=a(b[c],b):(b[c]=b[a],delete b[a])}),f(r.actions,function(a,b){"$"===b[0]&&(d[b]=function(){return t.$buildRequest(b,a,d)})}),g(d,b),g(d,h(r.instance)),d.$save=function(){var b=d[r.pk]?"update":"post",c=t[b](this);return d.$pending=!0,c.then(function(c){d.$pending=!1,c&&d.$update(c);var f="post"===b?"created":"updated";m.$broadcast(w+"-"+f,d),e.push(a.toJson(d))},function(){d.$pending=!1}),c},d.$destroy=function(){var a=t.delete(this);return d.$pending=!0,a.then(function(){d.$pending=!1;var a=d.$$array;a&&a.splice(a.indexOf(d),1),m.$broadcast(w+"-destroyed",d)},function(){d.$pending=!1}),a},d.$diff=function(b){var f=e[b||e.length-1],g=a.toJson(d);return c.diff(JSON.parse(f),JSON.parse(g),function(a,b){return"$"===b[0]})},d.$commit=function(){return e.push(a.toJson(d)),d},d.$rollback=function(a){var b=e[a||e.length-1];return d.$update(JSON.parse(b)),d},d.$update=function(a){return l(a,d),d},d.$copy=function(){var b=a.toJson(this);return new t(a.fromJson(b))},d.$commit()}var u={},v=p.split("/"),w=v[v.length-1];r=k({},h(d.defaultOptions),r);var x=function(a,b){var c=a.constructor===t?a:new t(a);return c.$$array=b,c},y=function(a){var b=a.toString();return b=b.substr("function ".length),b=b.substr(0,b.indexOf("("))},z=Math.random().toString(36).substr(2);return t.$cache=q(z),f(r.actions,function(a,b){"base"!==b&&"$"!==b[0]&&(t[b]=function(){var c=Array.prototype.slice.call(arguments);return t.$buildRequest.apply(this,[b,a].concat(c))})}),t.$buildRequest=function(b,c,d,e){var f=h(r.actions.base);g(f,h(c)),f.cache===!0&&(f.cache=t.$cache),f.method=f.method||"GET";var i=r.prefix?r.prefix+"/":"";if(f.override)i=f.url;else{if(i+=p,f.url){var j=!/^(\/|{\/)/.test(f.url);i+=j?"/"+f.url:f.url}if(i=t.$url(i,d,f.method),"get"!==b&&"post"!==b&&"update"!==b&&"delete"!==b||(i+="{/"+r.pk+"}"),"GET"===f.method&&(a.isString(d)||a.isNumber(d))){var l={};l[r.pk]=d,d=l,e&&(f.params=k({},f.params,e))}else"GET"===f.method&&a.isObject(d)&&(f.params=k({},f.params,d))}return f.url=t.$url(i,d,f.method),"delete"!==b&&"DELETE"!==f.method&&(f.data=d),t.$call(f)},t.$call=function(a){var b="POST"!==a.method,c=a.method+":"+a.url;if(b&&u[c])return u[c];var d=o.defer();return b&&(u[c]=d.promise),a.data=h(a.data),a.beforeRequest&&a.beforeRequest(a),a.data=t.$strip(a.data),n(a).then(function(b){if(a.afterRequest){var c=a.afterRequest(b.data);e(c)||(b.data=c)}a.invalidateCache&&t.$cache.removeAll(),b?a.wrap?a.isArray?d.resolve(new t.List(b.data)):d.resolve(new t(b.data)):d.resolve(b.data):d.resolve()},d.reject).finally(function(){b&&(u[c]=void 0)}),d.promise},t.$url=function(a,c,d){var e=new b(a||p).fill(function(a){var b=c[a];return b?("GET"===d&&delete c[a],b):null});return r.stripTrailingSlashes&&(e=e.replace(/\/+$/,"")||"/"),e},t.$strip=function(a){return a&&"object"==typeof a&&f(a,function(b,c){i.indexOf(c)>-1&&delete a[c]}),a},f(r,function(a,b){j.indexOf(b)===-1&&(t[b]=a)}),t.List=s,t}return r}]}),d});